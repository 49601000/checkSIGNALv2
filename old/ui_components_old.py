import streamlit as st

from data_fetch import convert_ticker, get_price_and_meta
from indicators import compute_indicators


def setup_page():
    st.set_page_config(page_title="è²·ã„ã‚·ã‚°ãƒŠãƒ«ãƒã‚§ãƒƒã‚«ãƒ¼", page_icon="ğŸ“Š")
    st.title("ğŸ”è²·ã„ã‚·ã‚°ãƒŠãƒ«ãƒã‚§ãƒƒã‚«ãƒ¼")


def render_app():
    setup_page()

    # ------------ API Key ãƒã‚§ãƒƒã‚¯ ------------
    if "ALPHA_VANTAGE_API_KEY" not in st.secrets:
        st.error("ALPHA_VANTAGE_API_KEY ãŒ st.secrets ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.stop()

    # ------------ å…¥åŠ› ------------
    user_input = st.text_input("ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š7203, 8306.T, AAPLï¼‰", value="")
    ticker = convert_ticker(user_input)

    if not ticker:
        st.stop()

    # ------------ ãƒ‡ãƒ¼ã‚¿å–å¾— ------------
    try:
        base = get_price_and_meta(ticker)
    except ValueError as e:
        st.error(str(e))
        st.stop()

    df = base["df"]
    close_col = base["close_col"]
    close = base["close"]
    previous_close = base["previous_close"]
    high_52w = base["high_52w"]
    low_52w = base["low_52w"]
    company_name = base["company_name"]
    dividend_yield = base["dividend_yield"]

    # ãƒ•ã‚¡ãƒ³ãƒ€ç³»
    eps = base.get("eps")
    bps = base.get("bps")
    eps_fwd = base.get("eps_fwd")
    per_fwd = base.get("per_fwd")
    roe = base.get("roe")
    roa = base.get("roa")
    equity_ratio = base.get("equity_ratio")

    # ------------ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ« + QVT ã‚¹ã‚³ã‚¢è¨ˆç®— ------------
    try:
        tech = compute_indicators(
            df,
            close_col,
            high_52w,
            low_52w,
            eps=eps,
            bps=bps,
            eps_fwd=eps_fwd,
            per_fwd=per_fwd,
            roe=roe,
            roa=roa,
            equity_ratio=equity_ratio,
            dividend_yield=dividend_yield,
        )
    except ValueError as e:
        st.error(str(e))
        st.stop()

    # ------------ ä¾¡æ ¼ã®è‰² ------------
    if close > previous_close:
        price_color = "red"
    elif close < previous_close:
        price_color = "green"
    else:
        price_color = "black"

    # ------------ ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆä¾¡æ ¼ + PER/PBR + MAï¼‰------------
    st.markdown("---")
    st.markdown(f"## ğŸ“Œ {ticker}ï¼ˆ{company_name}ï¼‰")

    per_val = tech.get("per")
    pbr_val = tech.get("pbr")
    per_str = f"{per_val:.2f}å€" if per_val is not None else "â€”"
    pbr_str = f"{pbr_val:.2f}å€" if pbr_val is not None else "â€”"

    per_fwd_val = tech.get("per_fwd")
    per_fwd_str = f"{per_fwd_val:.2f}å€" if per_fwd_val is not None else "â€”"

    html_header = (
        f"**ç¾åœ¨ä¾¡æ ¼**: "
        f"<span style='color:{price_color}; font-weight:bold;'>{close:.2f}</span><br>"
        f"ï¼ˆå‰æ—¥çµ‚å€¤: {previous_close:.2f}ï¼‰  <br><br>"
        f"**PER**: {per_str} ï½œ **äºˆæƒ³PER**: {per_fwd_str} ï½œ **PBR**: {pbr_str}  <br><br>"
        f"**25MA**: {tech['ma25']:.2f} {tech['arrow25']} ï½œ "
        f"**50MA**: {tech['ma50']:.2f} {tech['arrow50']} ï½œ "
        f"**75MA**: {tech['ma75']:.2f} {tech['arrow75']}"
    )
    st.markdown(html_header, unsafe_allow_html=True)

    # ------------ RSI / BB / é…å½“ / é«˜å€¤æ´ã¿ã‚¢ãƒ©ãƒ¼ãƒˆ ------------
    st.markdown(
        f"""
**RSI**: {tech["rsi"]:.1f} ï½œ **BBåˆ¤å®š**: {tech["bb_icon"]} {tech["bb_text"]}
        """
    )

    if tech.get("high_price_alert"):
        st.warning("âš ï¸ é«˜å€¤æ´ã¿ãƒªã‚¹ã‚¯ï¼ˆé«˜å€¤åœã«è¿‘ã„æ°´æº–ã§ã™ï¼‰")

    if dividend_yield is not None:
        st.markdown(f"**äºˆæƒ³é…å½“åˆ©å›ã‚Šï¼ˆéå»1å¹´ãƒ™ãƒ¼ã‚¹ï¼‰**: {dividend_yield:.2f}%")

    # ================================
    # ğŸ§© QVT ã‚¹ã‚³ã‚¢ + ã‚¿ãƒ–æ§‹æˆ
    # ================================
    st.markdown("---")
    st.markdown("### ğŸ§© QVTã‚¹ã‚³ã‚¢ï¼ˆè³ªÃ—å€¤æœ­Ã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰")

    q_score = float(tech.get("q_score", 0.0))
    v_score = float(tech.get("v_score", 0.0))
    t_score = float(tech.get("t_score", 0.0))
    qvt_score = float(tech.get("qvt_score", 0.0))
    timing_label = tech.get("timing_label", "")

    # --- ã‚¿ãƒ–æ§‹æˆ ---
    tab_t, tab_q, tab_v, tab_qvt = st.tabs(
        ["Tï¼ˆæŠ¼ã—ç›®ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰", "Qï¼ˆãƒ“ã‚¸ãƒã‚¹ã®è³ªï¼‰", "Vï¼ˆãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰", "QVTï¼ˆç·åˆï¼‰"]
    )

    # ================================
    # ğŸŸ¦ Tã‚¿ãƒ–ï¼šæŠ¼ã—ç›®ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚° + è£é‡ãƒ¬ãƒ³ã‚¸
    # ================================
    with tab_t:
        st.subheader("â° Tï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰")

        # â˜… ã‚¿ã‚¤ãƒŸãƒ³ã‚°è©•ä¾¡ã‚’å¤§ãã‚ãƒ»é’ã§å¼·èª¿è¡¨ç¤º
        st.metric("Tã‚¹ã‚³ã‚¢ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰", f"{t_score:.1f} / 100")

        st.markdown(
            f"""
            <div style="font-size:1.2rem; color:#0066cc; font-weight:bold;">
                ã‚¿ã‚¤ãƒŸãƒ³ã‚°è©•ä¾¡: {timing_label}
            </div>
            """,
            unsafe_allow_html=True,
        )

        st.markdown("---")
        st.markdown("### ğŸ“Œ è£é‡è²·ã„ãƒ¬ãƒ³ã‚¸ï¼ˆç›®å®‰ï¼‰")

        trend_conditions = tech.get("trend_conditions", [False, False, False])
        contrarian_conditions = tech.get("contrarian_conditions", [False, False, False])
        qvt_good = qvt_score >= 60

        # é †å¼µã‚Šãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ï¼ˆ25 > 50 > 75 or t_mode == "trend"ï¼‰
        is_trend_mode = tech.get("t_mode") == "trend" or trend_conditions[0]

        if is_trend_mode:
            mode_label = "ğŸ“ˆ é †å¼µã‚Šï¼ˆä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰æŠ¼ã—ç›®ç‹™ã„ï¼‰"

            mid_trend_ok = "â—‹" if trend_conditions[0] else "Ã—"
            short_trend_ok = "â—‹" if trend_conditions[1] else "Ã—"
            qvt_ok = "â—‹" if qvt_good else "Ã—"

            center_price = (tech["ma25"] + tech["ma50"]) / 2
            upper_price = center_price * 1.03
            lower_price = max(center_price * 0.95, tech["bb_lower1"])

            comment_text = tech.get("trend_comment", "è²·ã„æ¤œè¨ã‚³ãƒ¡ãƒ³ãƒˆãªã—")

            mid_trend_text = "25MA ï¼ 50MA ï¼ 75MA"
            short_trend_text = "MA25 æ¨ªã°ã„ã€œç·©ã‚„ã‹ä¸Šæ˜‡"

        else:
            mode_label = "ğŸ§® é€†å¼µã‚Šï¼ˆä¸‹è½ or èª¿æ•´å±€é¢ã®æŠ¼ã—ç›®ç‹™ã„ï¼‰"

            mid_trend_ok = "â—‹" if contrarian_conditions[0] else "Ã—"
            short_trend_ok = "â—‹" if contrarian_conditions[1] else "Ã—"
            qvt_ok = "â—‹" if qvt_good else "Ã—"

            center_price = (tech["ma25"] + tech["bb_lower1"]) / 2
            upper_price = center_price * 1.08
            lower_price = center_price * 0.97

            comment_text = tech.get("contr_comment", "é€†å¼µã‚Šã‚³ãƒ¡ãƒ³ãƒˆãªã—")

            mid_trend_text = "ä¸‹é™ or æ¨ªã°ã„ï¼ˆor MAæ¥è¿‘ï¼‰"
            short_trend_text = "MA25 ä¸‹é™"

        # â‘  ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        st.markdown(f"**ãƒ¢ãƒ¼ãƒ‰**: {mode_label}")

        # â‘¡ ç’°å¢ƒãƒã‚§ãƒƒã‚¯ï¼ˆã€‡Ã—ï¼‰ãƒ†ãƒ¼ãƒ–ãƒ«
        st.markdown(
            f"""
    | é …ç›® | å†…å®¹ | åˆ¤å®š |
    |---|---|:---:|
    | ä¸­æœŸãƒˆãƒ¬ãƒ³ãƒ‰ | {mid_trend_text} | {mid_trend_ok} |
    | çŸ­æœŸå‚¾å‘ | {short_trend_text} | {short_trend_ok} |
    | ç·åˆåŠ› | QVTã‚¹ã‚³ã‚¢ â‰§ 60 | {qvt_ok} |
            """
        )

        # â˜… ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤§ãã‚ãƒ»é’ã§å¼·èª¿è¡¨ç¤º
        st.markdown(
            f"""
            <div style="font-size:1.1rem; color:#0066cc; font-weight:bold; margin-top:0.5rem;">
                ã‚³ãƒ¡ãƒ³ãƒˆ: {comment_text}
            </div>
            """,
            unsafe_allow_html=True,
        )

        # â‘¢ ä¸­å¿ƒä¾¡æ ¼ + ãƒ¬ãƒ³ã‚¸
        st.markdown(
            f"""
    ä¸­å¿ƒä¾¡æ ¼ï¼ˆç›®å®‰ï¼‰: **{center_price:.2f}**  
    è²·ã„æ¤œè¨ãƒ¬ãƒ³ã‚¸ï¼ˆç›®å®‰ï¼‰: **{lower_price:.2f} ã€œ {upper_price:.2f}**
            """
        )
    
        st.info(
            "â€» ç’°å¢ƒãƒã‚§ãƒƒã‚¯ï¼ˆã€‡Ã—ï¼‰ã¨è£é‡è²·ã„ãƒ¬ãƒ³ã‚¸ã¯ã€"
            "ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ»QVTã‚¹ã‚³ã‚¢ã‚’çµ„ã¿åˆã‚ã›ãŸâ€œç›®å®‰â€ã§ã™ã€‚"
            "å®Ÿéš›ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã¯ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã‚„PFå…¨ä½“ã®ãƒãƒ©ãƒ³ã‚¹ã‚‚åŠ å‘³ã—ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚"
        )


    # ================================
    # ğŸŸ© Qã‚¿ãƒ–ï¼šãƒ“ã‚¸ãƒã‚¹ã®è³ª
    # ================================
    with tab_q:
        st.subheader("ğŸ¢ Qï¼ˆãƒ“ã‚¸ãƒã‚¹ã®è³ªï¼‰")

        st.metric("Qã‚¹ã‚³ã‚¢", f"{q_score:.1f} / 100")

        # â”€ è²¡å‹™ãƒ»åç›Šæ€§ã®æ¦‚è¦ï¼ˆç”Ÿã®æ•°å€¤ï¼‰ â”€
        if roe is not None or roa is not None or equity_ratio is not None:
            st.markdown("#### è²¡å‹™ãƒ»åç›Šæ€§ã®æ¦‚è¦")
            st.markdown(
                f"""
- ROE: **{roe:.1f}%**  *ï¼ˆè‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ï¼‰*  
- ROA: **{roa:.1f}%**  *ï¼ˆç·è³‡ç”£åˆ©ç›Šç‡ï¼‰*  
- è‡ªå·±è³‡æœ¬æ¯”ç‡: **{equity_ratio:.1f}%**  *ï¼ˆè²¡å‹™ã®å®‰å…¨æ€§ï¼‰*
                """
            )
        else:
            st.caption("ROE / ROA / è‡ªå·±è³‡æœ¬æ¯”ç‡ã®ä¸€éƒ¨ã¾ãŸã¯å…¨éƒ¨ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚")

        st.markdown("---")

        # â”€ â‘  æŒ‡æ¨™ã®ä¸€èˆ¬çš„ãªè¦‹æ–¹ â”€
        st.markdown("#### â‘  ã“ã‚Œã‚‰ã®æŒ‡æ¨™ã®ä¸€èˆ¬çš„ãªè¦‹æ–¹")

        st.markdown(
            """
- **ROEï¼ˆè‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ï¼‰**  
  - æ ªä¸»ãŒå‡ºã—ãŸãŠé‡‘ï¼ˆè‡ªå·±è³‡æœ¬ï¼‰ã‚’ã©ã‚Œã ã‘åŠ¹ç‡ã‚ˆãå¢—ã‚„ã—ã¦ã„ã‚‹ã‹ã€‚  
  - **ã–ã£ãã‚Šç›®å®‰**ï¼š  
    - 10% å‰å¾Œ â€¦ ã€Œæ¨™æº–ã€œã‚„ã‚„å„ªç§€ã€  
    - 15% ä»¥ä¸Š â€¦ ã€Œã‹ãªã‚Šé«˜åç›Šã€  
  - ãŸã ã—ã€è‡ªå·±è³‡æœ¬æ¯”ç‡ãŒä½ã„ã®ã« ROE ã ã‘é«˜ã„å ´åˆã¯ã€**å€Ÿå…¥ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã§ç››ã£ã¦ã„ã‚‹å¯èƒ½æ€§**ã‚‚ã‚ã‚‹ã€‚

- **ROAï¼ˆç·è³‡ç”£åˆ©ç›Šç‡ï¼‰**  
  - ä¼šç¤¾ãŒæŒã£ã¦ã„ã‚‹ç·è³‡ç”£ï¼ˆç¾é‡‘ãƒ»è¨­å‚™ãƒ»ä¸å‹•ç”£ãƒ»æŠ•è³‡ãªã©ï¼‰ã‚’ã©ã‚Œã ã‘åˆ©ç›Šã«å¤‰ãˆã‚‰ã‚Œã¦ã„ã‚‹ã‹ã€‚  
  - **ã–ã£ãã‚Šç›®å®‰**ï¼š  
    - 3ã€œ5% â€¦ ã€Œæ¨™æº–ã€  
    - 5ã€œ8%ä»¥ä¸Š â€¦ ã€Œã‹ãªã‚ŠåŠ¹ç‡çš„ã€  
  - ROA ãŒã—ã£ã‹ã‚Šé«˜ã„ã»ã©ã€ã€Œè³‡ç”£ã®ä½¿ã„æ–¹ãŒã†ã¾ã„ãƒ“ã‚¸ãƒã‚¹ã€ã€‚

- **è‡ªå·±è³‡æœ¬æ¯”ç‡**  
  - ç·è³‡ç”£ã®ã†ã¡ã€ã©ã‚Œã ã‘ã‚’**è‡ªå‰ã®è³‡æœ¬**ã§è³„ã£ã¦ã„ã‚‹ã‹ï¼ˆâ‰’ã©ã‚Œã ã‘å€Ÿé‡‘ã«ä¾å­˜ã—ã¦ã„ãªã„ã‹ï¼‰ã€‚  
  - **ã–ã£ãã‚Šç›®å®‰**ï¼š  
    - 30% æœªæº€ â€¦ æ”»ã‚æ°—å‘³ãƒ»ãƒ¬ãƒãƒ¬ãƒƒã‚¸é«˜ã‚ï¼ˆæ™¯æ°—æ‚ªåŒ–å±€é¢ã§ã¯æ³¨æ„ï¼‰  
    - 40ã€œ50% â€¦ æ¨™æº–ã€œã‚„ã‚„å¥å…¨  
    - 60%ä»¥ä¸Š â€¦ ã‹ãªã‚Šå …ã„è²¡å‹™ä½“è³ªï¼ˆãã®ã¶ã‚“æˆé•·æŠ•è³‡ã¯æ§ãˆã‚ãªã‚±ãƒ¼ã‚¹ã‚‚ï¼‰
            """
        )

        st.markdown("---")

        # â”€ â‘¡ ã‚»ã‚¯ã‚¿ãƒ¼ã”ã¨ã®ã–ã£ãã‚Šç›®å®‰ â”€
        st.markdown("#### â‘¡ ã‚»ã‚¯ã‚¿ãƒ¼ã”ã¨ã®ã–ã£ãã‚Šç›®å®‰")

        st.markdown(
            """
â€»ã‚ãã¾ã§ã€Œã–ã£ãã‚Šã—ãŸæ„Ÿè¦šå€¤ã€ã§ã™ã€‚å€‹åˆ¥éŠ˜æŸ„ã‚„å›½ã”ã¨ã«ã‹ãªã‚Šãƒ–ãƒ¬ãŒã‚ã‚Šã¾ã™ã€‚

| ã‚»ã‚¯ã‚¿ãƒ¼ã®ä¾‹ | ROE ã®ç›®å®‰ | ROA ã®ç›®å®‰ | è‡ªå·±è³‡æœ¬æ¯”ç‡ã®ç›®å®‰ |
|---|---|---|---|
| ç”Ÿæ´»å¿…éœ€å“ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆé£Ÿå“ãƒ»æ—¥ç”¨å“ãƒ»é‰„é“ãƒ»é›»åŠ›ãƒ»é€šä¿¡ãªã©ï¼‰ | 8ã€œ12% | 3ã€œ6% | 40ã€œ60%ä»¥ä¸Š |
| æˆé•·æ ªãƒ»ãƒ†ãƒƒã‚¯ï¼ˆã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ»åŠå°ä½“ãƒ»ãƒãƒƒãƒˆã‚µãƒ¼ãƒ“ã‚¹ãªã©ï¼‰ | 10ã€œ20%ä»¥ä¸Š | 5ã€œ10% | 30ã€œ50%ï¼ˆã‚„ã‚„ä½ã‚ã§ã‚‚è¨±å®¹ï¼‰ |
| æ™¯æ°—æ•æ„Ÿï¼ˆè‡ªå‹•è»Šãƒ»æ©Ÿæ¢°ãƒ»ç´ æãªã©ï¼‰ | 8ã€œ12% | 3ã€œ6% | 30ã€œ50% |
| è³‡æœ¬é›†ç´„ï¼ˆä¸å‹•ç”£ãƒ»å•†ç¤¾ãƒ»é‡å·¥ãƒ»ãƒ—ãƒ©ãƒ³ãƒˆãªã©ï¼‰ | 6ã€œ10% | 2ã€œ5% | 30ã€œ50% |
| é‡‘èï¼ˆéŠ€è¡Œãƒ»ä¿é™ºãƒ»è¨¼åˆ¸ãªã©ï¼‰ | 8ã€œ12% | 0.5ã€œ2% | è¦åˆ¶ä¸Šã®è‡ªå·±è³‡æœ¬æ¯”ç‡ã‚’è¦‹ã‚‹ï¼ˆå˜ç´”æ¯”è¼ƒã¯ä¸å¯ï¼‰ |
            """
        )

        st.markdown("---")

        # â”€ â‘¢ çµ„ã¿åˆã‚ã›ã§ã©ã†èª­ã‚€ã‹ã®å…·ä½“ä¾‹ â”€
        st.markdown("#### â‘¢ çµ„ã¿åˆã‚ã›ã§ã©ã†èª­ã‚€ã‹ã®ä¾‹")

        st.markdown(
            """
- **ä¾‹Aï¼šROE 15% / ROA 7% / è‡ªå·±è³‡æœ¬æ¯”ç‡ 60%**  
  â†’ é«˜åç›Šã‹ã¤è³‡ç”£åŠ¹ç‡ã‚‚é«˜ãã€è²¡å‹™ã‚‚å …ã„ã€‚  
  â†’ **ã€Œæ”»å®ˆãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„é«˜å“è³ªãƒ“ã‚¸ãƒã‚¹ã€** ã¨è©•ä¾¡ã—ã‚„ã™ã„ã€‚

- **ä¾‹Bï¼šROE 15% / ROA 3% / è‡ªå·±è³‡æœ¬æ¯”ç‡ 20%**  
  â†’ ROE ã¯é«˜ã„ãŒã€ROA ã¯å¹³å‡¡ã§è‡ªå·±è³‡æœ¬æ¯”ç‡ãŒä½ã„ã€‚  
  â†’ å€Ÿå…¥ãƒ¬ãƒãƒ¬ãƒƒã‚¸ã§ ROE ã‚’ç¨¼ã„ã§ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ãã€**æ™¯æ°—æ‚ªåŒ–æ™‚ã®ãƒ€ã‚¦ãƒ³ã‚µã‚¤ãƒ‰ãƒªã‚¹ã‚¯ã¯å¤§ãã‚**ã€‚

- **ä¾‹Cï¼šROE 6% / ROA 4% / è‡ªå·±è³‡æœ¬æ¯”ç‡ 70%**  
  â†’ æ”»ã‚ã¦ã¯ã„ãªã„ãŒã€è³‡ç”£åŠ¹ç‡ã¯ãã“ãã“ã€è²¡å‹™ã¯ã‹ãªã‚Šå …ã„ã€‚  
  â†’ ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–é«˜é…å½“æ ªã§ã‚ˆãè¦‹ã‚‹ã‚¿ã‚¤ãƒ—ã§ã€**ã€Œå¤§ããã¯ä¼¸ã³ãªã„ãŒæ½°ã‚Œã«ãã„ã€**ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

- **ä¾‹Dï¼šROE 3% / ROA 1% / è‡ªå·±è³‡æœ¬æ¯”ç‡ 30%**  
  â†’ åç›Šæ€§ã‚‚è³‡ç”£åŠ¹ç‡ã‚‚ä½ãã€è²¡å‹™ã‚‚æ™®é€šã€œã‚„ã‚„å¼±ã„ã€‚  
  â†’ æ§‹é€ çš„ãªç«¶äº‰åŠ›ã‚„ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã«ç–‘å•ãŒæ®‹ã‚‹æ°´æº–ã§ã€**ä»–ã«è‰¯ã„é¸æŠè‚¢ãŒã‚ã‚Œã°å„ªå…ˆåº¦ã¯ã‹ãªã‚Šä½ã„**ã€‚
            """
        )

        st.markdown("---")
        st.caption(
            "Qã‚¹ã‚³ã‚¢ã¯ã“ã‚Œã‚‰ã®æŒ‡æ¨™ã‚’ 0ã€œ100 ã«åœ§ç¸®ã—ãŸâ€œã–ã£ãã‚ŠæŒ‡æ¨™â€ã§ã™ã€‚"
            "æœ€çµ‚çš„ãªåˆ¤æ–­ã§ã¯ã€å¿…ãšã‚»ã‚¯ã‚¿ãƒ¼ç‰¹æ€§ã¨ä¸Šã®ã‚ˆã†ãªçµ„ã¿åˆã‚ã›ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’åŠ å‘³ã—ã¦ã€"
            "è‡ªåˆ†ã®ç›®ã§ã€Œã“ã®ãƒ“ã‚¸ãƒã‚¹ã¯ã©ã‚“ãªã‚¿ã‚¤ãƒ—ã‹ï¼Ÿã€ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ä½¿ã£ã¦ãã ã•ã„ã€‚"
        )

    # ================================
    # ğŸŸ¨ Vã‚¿ãƒ–ï¼šãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
    # ================================
    with tab_v:
        st.subheader("ğŸ’° Vï¼ˆãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰")

        st.metric("Vã‚¹ã‚³ã‚¢", f"{v_score:.1f} / 100")

        st.markdown("#### ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™")
        st.markdown(
            f"""
- PERï¼ˆå®Ÿç¸¾ï¼‰: **{per_str}**  
- äºˆæƒ³PER: **{per_fwd_str}**  
- PBR: **{pbr_str}**  
- é…å½“åˆ©å›ã‚Š: **{dividend_yield:.2f}%**  
            """
            if dividend_yield is not None
            else f"""
- PERï¼ˆå®Ÿç¸¾ï¼‰: **{per_str}**  
- äºˆæƒ³PER: **{per_fwd_str}**  
- PBR: **{pbr_str}**  
- é…å½“åˆ©å›ã‚Š: **â€”ï¼ˆå–å¾—ä¸å¯ï¼‰**  
            """
        )

        st.markdown("---")
        st.caption(
            "Vã‚¹ã‚³ã‚¢ã¯ PER / PBR / é…å½“åˆ©å›ã‚Š ã‚’ã‚‚ã¨ã« 0ã€œ100 ã«æ­£è¦åŒ–ã—ãŸæŒ‡æ¨™ã§ã™ã€‚"
            "ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–æ ªãƒ»ã‚°ãƒ­ãƒ¼ã‚¹æ ªãªã©ã€ã‚»ã‚¯ã‚¿ãƒ¼ã”ã¨ã«â€œå‰²å®‰ / å‰²é«˜â€ã®åŸºæº–ã¯ç•°ãªã‚‹ãŸã‚ã€"
            "ã‚¹ã‚³ã‚¢ã¨ã‚ã‚ã›ã¦ç”Ÿã®æŒ‡æ¨™ã‚’ã‚»ã‚¯ã‚¿ãƒ¼æ„Ÿè¦šã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚"
        )

    # ================================
    # ğŸŸ¥ QVTã‚¿ãƒ–ï¼šç·åˆè©•ä¾¡
    # ================================
    with tab_qvt:
        st.subheader("ğŸ§® QVTï¼ˆç·åˆè©•ä¾¡ï¼‰")

        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("Qï¼ˆè³ªï¼‰", f"{q_score:.1f} / 100")
        with col2:
            st.metric("Vï¼ˆå€¤æœ­ï¼‰", f"{v_score:.1f} / 100")
        with col3:
            st.metric("Tï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰", f"{t_score:.1f} / 100")
        with col4:
            st.metric("QVTç·åˆã‚¹ã‚³ã‚¢", f"{qvt_score:.1f} / 100")

        st.markdown("---")

        st.markdown("#### ç·åˆã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä½¿ã„æ–¹ã®ç›®å®‰ï¼‰")

        if qvt_score >= 70:
            msg = "ç·åˆçš„ã«ã‹ãªã‚Šé­…åŠ›çš„ãªæ°´æº–ã€‚PFå…¨ä½“ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã‚’è¦‹ã¤ã¤ã€ä¸»åŠ›å€™è£œã¨ã—ã¦æ¤œè¨ã—ã¦ã‚ˆã„ãƒ¬ãƒ™ãƒ«ã€‚"
        elif qvt_score >= 60:
            msg = "ç·åˆçš„ã«â€œè²·ã„æ¤œè¨â€ãƒ¬ãƒ™ãƒ«ã€‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚„ãƒ­ãƒƒãƒˆèª¿æ•´ã‚’æ„è­˜ã—ã¤ã¤ã€åˆ†å‰²ã§ã®å‚åŠ ã‚’æ¤œè¨ã€‚"
        elif qvt_score >= 50:
            msg = "æ‚ªãã¯ãªã„ãŒã€ä»–å€™è£œã¨ã®æ¯”è¼ƒã‚„ã‚»ã‚¯ã‚¿ãƒ¼ç‰¹æ€§ã‚’è¸ã¾ãˆã¦æ…é‡ã«ã€‚ç„¡ç†ã«å¼¾ã‚’ä½¿ã†å¿…è¦ã¯ãªã„ã‚¾ãƒ¼ãƒ³ã€‚"
        else:
            msg = "ç·åˆåŠ›ã¨ã—ã¦ã¯ã‚„ã‚„ç‰©è¶³ã‚Šãªã„æ°´æº–ã€‚ã‚ˆã»ã©ã®ãƒ†ãƒ¼ãƒæ€§ã‚„PFå†…ã§ã®å½¹å‰²ãŒãªã„é™ã‚Šã€è¦‹é€ã‚Šã‚‚é¸æŠè‚¢ã€‚"

        st.write(msg)

        st.markdown("---")
        st.caption(
            "QVTã‚¹ã‚³ã‚¢ã¯ Qãƒ»Vãƒ»T ã‚’åŒç­‰ã‚¦ã‚§ã‚¤ãƒˆã§å¹³å‡ã—ãŸæŒ‡æ¨™ã§ã™ã€‚"
            "æœ€çµ‚çš„ãªæŠ•è³‡åˆ¤æ–­ã§ã¯ã€ã‚»ã‚¯ã‚¿ãƒ¼ç‰¹æ€§ãƒ»ãƒ†ãƒ¼ãƒæ€§ãƒ»ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå…¨ä½“ã®å½¹å‰²ã‚’åŠ å‘³ã—ã¦ã€"
            "è‡ªåˆ†ã®â€œé•å’Œæ„Ÿâ€ã‚‚å«ã‚ã¦ä¸Šæ›¸ãè©•ä¾¡ã—ã¦ãã ã•ã„ã€‚"
        )
